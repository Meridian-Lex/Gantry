events {
    worker_connections 1024;
}

http {
    # DNS resolver for dynamic upstream resolution
    resolver 127.0.0.11 valid=30s;

    server {
        listen 8000;

        # Health check
        location /health {
            access_log off;
            default_type text/plain;
            return 200 "OK\n";
        }

        # Qdrant proxy
        location /qdrant/ {
            set $upstream_qdrant lex-qdrant:6333;
            proxy_pass http://$upstream_qdrant;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # OpenSearch proxy
        # proxy_ssl_verify is disabled: OpenSearch runs on the internal Docker bridge
        # network with a self-signed certificate. Verification is not meaningful
        # for intra-container traffic and no external CA bundle is available.
        location /opensearch/ {
            set $upstream_opensearch lex-opensearch:9200;
            proxy_pass https://$upstream_opensearch;
            proxy_ssl_verify off;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # RabbitMQ Management API proxy
        location /rabbitmq/ {
            set $upstream_rabbitmq lex-rabbitmq:15672;
            proxy_pass http://$upstream_rabbitmq/api/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # ntfy proxy
        location /ntfy/ {
            set $upstream_ntfy lex-ntfy:80;
            proxy_pass http://$upstream_ntfy;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
