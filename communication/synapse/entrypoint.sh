#!/usr/bin/env bash
# Synapse broker entrypoint (reference copy â€” canonical version lives in Meridian-Lex/Synapse repo)
# 1. Substitute env vars into config template -> /tmp/synapse-resolved.yaml
# 2. Exec broker (sqlx applies migrations on startup)
set -euo pipefail

CONFIG_TEMPLATE="${SYNAPSE_CONFIG_TEMPLATE:-/etc/synapse/synapse.yaml}"
CONFIG_LIVE=/tmp/synapse-resolved.yaml

echo "[synapse] Resolving config from $CONFIG_TEMPLATE..."
envsubst '${SYNAPSE_DB_PASSWORD} ${REDIS_PASSWORD}' < "$CONFIG_TEMPLATE" > "$CONFIG_LIVE"

echo "[synapse] Starting broker (sqlx applies migrations on startup)..."
export SYNAPSE_CONFIG="$CONFIG_LIVE"
exec /usr/local/bin/synapse-broker
